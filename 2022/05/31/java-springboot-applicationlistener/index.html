


  
  
  

  

  

  

  

  

  
  
  
  
    
       
    

    

    
    
  
    

    

    
    
  
    

    

    
    
  
    

    

    
    
  
    

    

    
    
  
    

    

    
    
  
    

    

    
    
  
    

    

    
    
  
    

    

    
    
  
    

    

    
    
  
    

    

    
    
  
    

    

    
    
  
    

    

    
    
  

  
  

  
  
  

  

  

  

  

  
  
  
  
  
  
  
  
  
  
  
  
  
  
  

  
  <!DOCTYPE html><html lang="zh-cmn-Hans" prefix="og: http://ogp.me/ns#" class="han-init"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" /><title>SpringBoot（一）SpringBoot中的事件机制 &mdash; 零度</title><link rel="stylesheet" href="https://hsfeng.site/assets/vendor/primer-css/css/primer.css"><link rel="stylesheet" href="https://hsfeng.site/assets/css/components/collection.css"><link rel="stylesheet" href="https://hsfeng.site/assets/css/components/repo-card.css"><link rel="stylesheet" href="https://hsfeng.site/assets/css/sections/repo-list.css"><link rel="stylesheet" href="https://hsfeng.site/assets/css/components/boxed-group.css"><link rel="stylesheet" href="https://hsfeng.site/assets/css/globals/common.css"><link rel="stylesheet" href="https://hsfeng.site/assets/css/globals/responsive.css"><link rel="stylesheet" href="https://hsfeng.site/assets/css/posts/index.css"><link rel="stylesheet" href="https://hsfeng.site/assets/vendor/octicons/octicons/octicons.css"> <!-- --> <!-- --><link rel="stylesheet" href="https://hsfeng.site/assets/rouge-themes/dist/github.css"> <!-- Latest compiled and minified CSS --><link rel="canonical" href="https://hsfeng.site/2022/05/31/java-springboot-applicationlistener/"><link rel="alternate" type="application/atom+xml" title="零度" href="https://hsfeng.site/feed.xml"><link rel="shortcut icon" href="https://hsfeng.site/favicon.ico"><meta property="og:title" content="SpringBoot（一）SpringBoot中的事件机制"><meta name="keywords" content="SpringBoot"><meta name="og:keywords" content="SpringBoot"><meta name="description" content="在 SpringBoot 的启动过程中，会通过 SPI 机制去加载 spring.factories 下面的一些类，这里面就包括了事件相关的类。"><meta name="og:description" content="在 SpringBoot 的启动过程中，会通过 SPI 机制去加载 spring.factories 下面的一些类，这里面就包括了事件相关的类。"><meta property="og:url" content="https://hsfeng.site/2022/05/31/java-springboot-applicationlistener/"><meta property="og:site_name" content="零度"><meta property="og:type" content="article"><meta property="og:locale" content="zh_CN" /><meta property="article:published_time" content="2022-05-31"> <script src="https://hsfeng.site/assets/vendor/jquery/dist/jquery.min.js"></script> <script src="https://hsfeng.site/assets/js/jquery-ui.js"></script> <script src="https://hsfeng.site/assets/js/main.js"></script> <!-- --></head><body class="" data-mz=""><header class="site-header"><div class="container"><h1><a href="https://hsfeng.site/" title="零度"><span class="octicon octicon-mark-github"></span> 零度</a></h1><button class="collapsed mobile-visible" type="button" onclick="toggleMenu();"> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span> </button><nav class="site-header-nav" role="navigation"> <a href="https://hsfeng.site/" class=" site-header-nav-item" target="" title="首页">首页</a> <a href="https://hsfeng.site/categories/" class=" site-header-nav-item" target="" title="分类">分类</a> <a href="https://hsfeng.site/archives/" class=" site-header-nav-item" target="" title="归档">归档</a> <a href="https://hsfeng.site/wiki/" class=" site-header-nav-item" target="" title="维基">维基</a> <a href="https://hsfeng.site/links/" class=" site-header-nav-item" target="" title="链接">链接</a> <a href="https://hsfeng.site/about/" class=" site-header-nav-item" target="" title="关于">关于</a></nav></div></header><!-- / header --><section class="collection-head small geopattern" data-pattern-id="SpringBoot（一）Sp"><div class="container"><div class="columns"><div class="column three-fourths"><div class="collection-title"><h1 class="collection-header">SpringBoot（一）SpringBoot中的事件机制</h1><div class="collection-info"> <span class="meta-info"> <span class="octicon octicon-calendar"></span> 2022/05/31 </span> <span class="meta-info"> <span class="octicon octicon-file-directory"></span> <a href="https://hsfeng.site/categories/#Java" title="Java">Java</a> </span> <span class="meta-info"> <span class="octicon octicon-file-directory"></span> <a href="https://hsfeng.site/categories/#SpringBoot" title="SpringBoot">SpringBoot</a> </span> <span class="meta-info"> <span class="octicon octicon-clock"></span> 共 9786 字，约 28 分钟 </span></div></div></div><div class="column one-fourth mobile-hidden"><div class="collection-title"></div></div></div></div></section><!-- / .banner --><section class="container content"><div class="columns"><div class="column three-fourths" ><article class="article-content markdown-body"><p>在 SpringBoot 的启动过程中，会通过 SPI 机制去加载 spring.factories 下面的一些类，这里面就包括了事件相关的类。</p><ul><li>SpringApplicationRunListener</li></ul><div class="language-properties highlighter-rouge"><div class="highlight">
  
  
  
    <pre class="highlight"><code><span class="c"># Run Listeners
</span><span class="py">org.springframework.boot.SpringApplicationRunListener</span><span class="p">=</span>
<span class="err">org.springframework.boot.context.event.EventPublishingRunListener</span>
</code></pre>
  

  
 </div></div><ul><li>ApplicationListener</li></ul><div class="language-properties highlighter-rouge"><div class="highlight">
  
  
  
    <pre class="highlight"><code><span class="c"># Application Listeners
</span><span class="py">org.springframework.context.ApplicationListener</span><span class="p">=</span>
<span class="err">org.springframework.boot.ClearCachesApplicationListener,</span>
<span class="err">org.springframework.boot.builder.ParentContextCloserApplicationListener,</span>
<span class="err">org.springframework.boot.context.FileEncodingApplicationListener,</span>
<span class="err">org.springframework.boot.context.config.AnsiOutputApplicationListener,</span>
<span class="err">org.springframework.boot.context.config.ConfigFileApplicationListener,</span>
<span class="err">org.springframework.boot.context.config.DelegatingApplicationListener,</span>
<span class="err">org.springframework.boot.context.logging.ClasspathLoggingApplicationListener,</span>
<span class="err">org.springframework.boot.context.logging.LoggingApplicationListener,</span>
<span class="err">org.springframework.boot.liquibase.LiquibaseServiceLocatorApplicationListener</span>
</code></pre>
  

  
 </div></div><p>SpringApplicationRunListener 类是 SpringBoot 中新增的类。SpringApplication 类 中使用它们来间接调用 ApplicationListener。另外还有一个新增的类是SpringApplicationRunListeners，SpringApplicationRunListeners 中包含了多个 SpringApplicationRunListener。</p><h1 id="springapplicationrunlistener">SpringApplicationRunListener</h1><p>SpringApplicationRunListener 接口规定了 SpringBoot 的生命周期，在各个生命周期广播相应的事件，调用实际的 ApplicationListener 类。通过对 SpringApplicationRunListener 的分析，也可以对 SpringBoot 的整个启动过程的理解会有很大帮助。</p><p>先来看下SpringApplicationRunListener 接口的代码：</p><div class="language-java highlighter-rouge"><div class="highlight">
  
  
  
    <pre class="highlight"><code><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">SpringApplicationRunListener</span> <span class="o">{</span>
	<span class="c1">//当run方法首次启动时立即调用。可用于非常早期的初始化。</span>
	<span class="kt">void</span> <span class="nf">starting</span><span class="o">();</span>
	<span class="c1">//在准备好环境后，但在创建ApplicationContext之前调用。</span>
	<span class="kt">void</span> <span class="nf">environmentPrepared</span><span class="o">(</span><span class="nc">ConfigurableEnvironment</span> <span class="n">environment</span><span class="o">);</span>
	<span class="c1">//在创建和准备好ApplicationContext之后，但在加载源之前调用。</span>
	<span class="kt">void</span> <span class="nf">contextPrepared</span><span class="o">(</span><span class="nc">ConfigurableApplicationContext</span> <span class="n">context</span><span class="o">);</span>
	<span class="c1">//在加载应用程序上下文后但刷新之前调用</span>
	<span class="kt">void</span> <span class="nf">contextLoaded</span><span class="o">(</span><span class="nc">ConfigurableApplicationContext</span> <span class="n">context</span><span class="o">);</span>
	<span class="c1">//上下文已刷新，应用程序已启动，但尚未调用commandlinerunner和applicationrunner。</span>
	<span class="kt">void</span> <span class="nf">started</span><span class="o">(</span><span class="nc">ConfigurableApplicationContext</span> <span class="n">context</span><span class="o">);</span>
	<span class="c1">//在运行方法完成之前立即调用，此时应用程序上下文已刷新，</span>
	<span class="c1">//并且所有commandlinerunner和applicationrunner都已调用。</span>
	<span class="c1">//2.0 才有</span>
	<span class="kt">void</span> <span class="nf">running</span><span class="o">(</span><span class="nc">ConfigurableApplicationContext</span> <span class="n">context</span><span class="o">);</span>
	<span class="c1">//在运行应用程序时发生故障时调用。2.0 才有</span>
	<span class="kt">void</span> <span class="nf">failed</span><span class="o">(</span><span class="nc">ConfigurableApplicationContext</span> <span class="n">context</span><span class="o">,</span> <span class="nc">Throwable</span> <span class="n">exception</span><span class="o">);</span>
<span class="o">}</span>
</code></pre>
  

  
 </div></div><h1 id="springapplicationrunlisteners">SpringApplicationRunListeners</h1><p>上面提到，SpringApplicationRunListeners 是SpringApplicationRunListener的集合，里面包括了很多SpringApplicationRunListener实例；SpringApplication 类实际上使用的是 SpringApplicationRunListeners 类，与 SpringApplicationRunListener 生命周期相同，调用各个周期的 SpringApplicationRunListener 。然后广播相应的事件到 ApplicationListener。</p><div class="language-plaintext highlighter-rouge"><div class="highlight">
  
  
  
    <pre class="highlight"><code>代码详见：SpringApplicationRunListeners
</code></pre>
  

  
 </div></div><h2 id="eventpublishingrunlistener">EventPublishingRunListener</h2><p>EventPublishingRunListener 类是 SpringApplicationRunListener接口的实现类 ，它具有广播事件的功能。其内部使用 ApplicationEventMulticaster在实际刷新上下文之前发布事件。下面来看下 EventPublishingRunListener 类生命周期对应的事件。</p><h2 id="applicationstartingevent">ApplicationStartingEvent</h2><p>ApplicationStartingEvent 是 SpringBoot 启动开始的时候执行的事件，在该事件中可以获取到 SpringApplication 对象，可做一些执行前的设置，对应的调用方法是 starting()。</p><h2 id="applicationenvironmentpreparedevent">ApplicationEnvironmentPreparedEvent</h2><p>ApplicationEnvironmentPreparedEvent 是SpringBoot 对应 Enviroment 已经准备完毕时执行的事件，此时上下文 context 还没有创建。在该监听中获取到 ConfigurableEnvironment 后可以对配置信息做操作，例如：修改默认的配置信息，增加额外的配置信息等。对应的生命周期方法是 environmentPrepared(environment)；SpringCloud 中，引导上下文就是在这时初始化的。</p><h2 id="applicationcontextinitializedevent">ApplicationContextInitializedEvent</h2><p>当 SpringApplication 启动并且准备好 ApplicationContext，并且在加载任何 bean 定义之前调用了 ApplicationContextInitializers 时发布的事件。对应的生命周期方法是contextPrepared()。</p><h2 id="applicationpreparedevent">ApplicationPreparedEvent</h2><p>ApplicationPreparedEvent 是SpringBoot上下文 context 创建完成是发布的事件；但此时 spring 中的 bean 还没有完全加载完成。这里可以将上下文传递出去做一些额外的操作。但是在该监听器中是无法获取自定义 bean 并进行操作的。对应的生命周期方法是 contextLoaded()。</p><h2 id="applicationstartedevent">ApplicationStartedEvent</h2><p>这个事件是在 2.0 版本才引入的；具体发布是在应用程序上下文刷新之后，调用任何 ApplicationRunner 和 CommandLineRunner 运行程序之前。</p><h2 id="applicationreadyevent">ApplicationReadyEvent</h2><p>这个和 ApplicationStartedEvent 很类似，也是在应用程序上下文刷新之后之后调用，区别在于此时ApplicationRunner 和 CommandLineRunner已经完成调用了，也意味着 SpringBoot 加载已经完成。</p><h2 id="applicationfailedevent">ApplicationFailedEvent</h2><p>SpringBoot 启动异常时执行的事件，在异常发生时，最好是添加虚拟机对应的钩子进行资源的回收与释放，能友善的处理异常信息。</p><h2 id="demo-及各个事件的执行顺序">demo 及各个事件的执行顺序</h2><p>下面的各个事件对应的demo及打印出来的执行顺序。</p><ul><li>GlmapperApplicationStartingEventListener</li></ul><div class="language-java highlighter-rouge"><div class="highlight">
  
  
  
    <pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">GlmapperApplicationStartingEventListener</span> <span class="kd">implements</span> <span class="nc">ApplicationListener</span><span class="o">&lt;</span><span class="nc">ApplicationStartingEvent</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onApplicationEvent</span><span class="o">(</span><span class="nc">ApplicationStartingEvent</span> <span class="n">applicationStartingEvent</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"execute ApplicationStartingEvent ..."</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre>
  

  
 </div></div><ul><li>GlmapperApplicationEnvironmentPreparedEvent</li></ul><div class="language-java highlighter-rouge"><div class="highlight">
  
  
  
    <pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">GlmapperApplicationEnvironmentPreparedEvent</span> <span class="kd">implements</span> <span class="nc">ApplicationListener</span><span class="o">&lt;</span><span class="nc">ApplicationEnvironmentPreparedEvent</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onApplicationEvent</span><span class="o">(</span><span class="nc">ApplicationEnvironmentPreparedEvent</span> <span class="n">applicationEnvironmentPreparedEvent</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"execute ApplicationEnvironmentPreparedEvent ..."</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre>
  

  
 </div></div><ul><li>GlmapperApplicationContextInitializedEvent</li></ul><div class="language-java highlighter-rouge"><div class="highlight">
  
  
  
    <pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">GlmapperApplicationContextInitializedEvent</span> <span class="kd">implements</span> <span class="nc">ApplicationListener</span><span class="o">&lt;</span><span class="nc">ApplicationContextInitializedEvent</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onApplicationEvent</span><span class="o">(</span><span class="nc">ApplicationContextInitializedEvent</span> <span class="n">applicationContextInitializedEvent</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"execute applicationContextInitializedEvent ..."</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre>
  

  
 </div></div><ul><li>GlmapperApplicationPreparedEvent</li></ul><div class="language-java highlighter-rouge"><div class="highlight">
  
  
  
    <pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">GlmapperApplicationPreparedEvent</span> <span class="kd">implements</span> <span class="nc">ApplicationListener</span><span class="o">&lt;</span><span class="nc">ApplicationPreparedEvent</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onApplicationEvent</span><span class="o">(</span><span class="nc">ApplicationPreparedEvent</span> <span class="n">applicationPreparedEvent</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"execute ApplicationPreparedEvent ..."</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre>
  

  
 </div></div><ul><li>GlmapperApplicationStartedEvent</li></ul><div class="language-java highlighter-rouge"><div class="highlight">
  
  
  
    <pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">GlmapperApplicationStartedEvent</span> <span class="kd">implements</span> <span class="nc">ApplicationListener</span><span class="o">&lt;</span><span class="nc">ApplicationStartedEvent</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onApplicationEvent</span><span class="o">(</span><span class="nc">ApplicationStartedEvent</span> <span class="n">applicationStartedEvent</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"execute ApplicationStartedEvent ..."</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre>
  

  
 </div></div><ul><li>GlmapperApplicationReadyEvent</li></ul><div class="language-java highlighter-rouge"><div class="highlight">
  
  
  
    <pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">GlmapperApplicationReadyEvent</span> <span class="kd">implements</span> <span class="nc">ApplicationListener</span><span class="o">&lt;</span><span class="nc">ApplicationReadyEvent</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onApplicationEvent</span><span class="o">(</span><span class="nc">ApplicationReadyEvent</span> <span class="n">applicationReadyEvent</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"execute ApplicationReadyEvent ..."</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre>
  

  
 </div></div><ul><li>执行结果</li></ul><h1 id="springboot-中的事件体系">SpringBoot 中的事件体系</h1><p>这里围绕 SpringApplicationRunListener 这个类来说。在实现类 EventPublishingRunListener中，事件发布有两种模式：</p><ul><li><p>通过 SimpleApplicationEventMulticaster 进行事件广播</p></li><li><p>所有监听器交给相应的 Context</p></li></ul><p>所以EventPublishingRunListener 不仅负责发布事件，而且在合适的时机将 SpringApplication所获取的监听器和应用上下文作关联。</p><h2 id="simpleapplicationeventmulticaster">SimpleApplicationEventMulticaster</h2><p>SimpleApplicationEventMulticaster是 Spring 默认的事件广播器。来看下它是怎么工作的：</p><div class="language-java highlighter-rouge"><div class="highlight">
  
  
  
    <pre class="highlight"><code><span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">multicastEvent</span><span class="o">(</span><span class="kd">final</span> <span class="nc">ApplicationEvent</span> <span class="n">event</span><span class="o">,</span> <span class="nd">@Nullable</span> <span class="nc">ResolvableType</span> <span class="n">eventType</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">ResolvableType</span> <span class="n">type</span> <span class="o">=</span> <span class="o">(</span><span class="n">eventType</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">?</span> <span class="n">eventType</span> <span class="o">:</span> <span class="n">resolveDefaultEventType</span><span class="o">(</span><span class="n">event</span><span class="o">));</span>
    <span class="k">for</span> <span class="o">(</span><span class="kd">final</span> <span class="nc">ApplicationListener</span><span class="o">&lt;?&gt;</span> <span class="n">listener</span> <span class="o">:</span> <span class="n">getApplicationListeners</span><span class="o">(</span><span class="n">event</span><span class="o">,</span> <span class="n">type</span><span class="o">))</span> <span class="o">{</span>
        <span class="nc">Executor</span> <span class="n">executor</span> <span class="o">=</span> <span class="n">getTaskExecutor</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">executor</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">executor</span><span class="o">.</span><span class="na">execute</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="n">invokeListener</span><span class="o">(</span><span class="n">listener</span><span class="o">,</span> <span class="n">event</span><span class="o">));</span>
        <span class="o">}</span>
        <span class="k">else</span> <span class="o">{</span>
            <span class="n">invokeListener</span><span class="o">(</span><span class="n">listener</span><span class="o">,</span> <span class="n">event</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre>
  

  
 </div></div><p>从上面的代码段可以看出，它是通过遍历注册的每个监听器，并启动来调用每个监听器的 onApplicationEvent 方法。</p><p>下面再来看下 SimpleApplicationEventMulticaster 的类集成结构：</p><p>这里的AbstractApplicationContext下面来聊，这个类实际上就负责了事件体系的初始化工作。</p><h2 id="事件体系的初始化">事件体系的初始化</h2><p>事件体系的初始化对应在 SpringBoot启动过程的 refreshContext这个方法；refreshContext具体调用 AbstractApplicationContext.refresh()方法，最后调用 initApplicationEventMulticaster() 来完成事件体系的初始化,代码如下：</p><p>用户可以为容器定义一个自定义的事件广播器，只要实现 ApplicationEventMulticaster 就可以了，Spring 会通过 反射的机制将其注册成容器的事件广播器，如果没有找到配置的外部事件广播器，Spring 就是默认使用 SimpleApplicationEventMulticaster 作为事件广播器。</p><h2 id="事件注册">事件注册</h2><p>事件注册是在事件体系初始化完成之后做的事情，也是在 AbstractApplicationContext.refresh()方法中进行调用的。</p><p>这里干了三件事：</p><ul><li><p>首先注册静态指定的 listeners；这里包括我们自定义的那些监听器。</p></li><li><p>调用 DefaultListableBeanFactory 中 getBeanNamesForType 得到自定义的 ApplicationListener bean 进行事件注册。</p></li><li><p>广播早期的事件。</p></li></ul><h2 id="事件广播">事件广播</h2><p>事件发布伴随着 SpringBoot 启动的整个生命周期。不同阶段对应发布不同的事件，上面我们已经对各个事件进行了分析，下面就具体看下发布事件的实现：</p><div class="language-plaintext highlighter-rouge"><div class="highlight">
  
  
  
    <pre class="highlight"><code>org.springframework.context.support.AbstractApplicationContext#publishEvent

earlyApplicationEvents 中的事件是广播器未建立的时候保存通知信息，一旦容器建立完成，以后都是直接通知。
</code></pre>
  

  
 </div></div><p>广播事件最终还是通过调用 ApplicationEventMulticaster 的 multicastEvent 来实现。而 multicastEvent 也就就是事件执行的方法。</p><h2 id="事件执行">事件执行</h2><p>上面 SimpleApplicationEventMulticaster 小节已经初步介绍了 multicastEvent 这个方法。补充一点， 如果有可用的 taskExecutor 会使用并发的模式执行事件，但是实际上 SimpleApplicationEventMulticaster 并没有提供线程池实现，默认请况下是使用同步的方式执行事件（org.springframework.core.task.SyncTaskExecutor），所以如果需要异步配置的话，需要自己去实现线程池。</p><h1 id="springboot-启动过程中的事件阶段">SpringBoot 启动过程中的事件阶段</h1><p>这里回到 SpringApplication的run方法，看下 SpringBoot 在启动过程中，各个事件阶段做了哪些事情。</p><h2 id="starting---applicationstartingevent">starting -&gt; ApplicationStartingEvent</h2><p>这里 debug 到 starting 方法，追踪到 multicastEvent，这里 type为 ApplicationStartingEvent；对应的事件如下：</p><ul><li><p>LoggerApplicationListener：配置日志系统。使用logging.config环境变量指定的配置或者缺省配置</p></li><li><p>BackgroundPreinitializer：尽早触发一些耗时的初始化任务，使用一个后台线程</p></li><li><p>DelegatingApplicationListener：监听到事件后转发给环境变量context.listener.classes指定的那些事件监听器</p></li><li><p>LiquibaseServiceLocatorApplicationListener：使用一个可以和 SpringBoot 可执行jar包配合工作的版本替换 liquibase ServiceLocator</p></li></ul><h2 id="listenersenvironmentprepared-applicationenvironmentpreparedevent">listeners.environmentPrepared-&gt;ApplicationEnvironmentPreparedEvent</h2><ul><li><p>AnsiOutputApplicationListener：根据spring.output.ansi.enabled参数配置AnsiOutput</p></li><li><p>ConfigFileApplicationListener：EnvironmentPostProcessor，从常见的那些约定的位置读取配置文件，比如从以下目录读取application.properties,application.yml等配置文件：</p></li><li><p>classpath:</p></li><li><p>file:.</p></li><li><p>classpath:config</p></li><li><p>file:./config/</p></li></ul><p>也可以配置成从其他指定的位置读取配置文件。</p><ul><li><p>ClasspathLoggingApplicationListener：对环境就绪事件ApplicationEnvironmentPreparedEvent/应用失败事件ApplicationFailedEvent做出响应，往日志DEBUG级别输出TCCL(thread context class loader)的 classpath。</p></li><li><p>FileEncodingApplicationListener：如果系统文件编码和环境变量中指定的不同则终止应用启动。具体的方法是比较系统属性file.encoding和环境变量spring.mandatory-file-encoding是否相等(大小写不敏感)。</p></li></ul><h2 id="listenerscontextprepared-applicationcontextinitializedevent">listeners.contextPrepared-&gt;ApplicationContextInitializedEvent</h2><p>相关监听器参考上面的描述。</p><h2 id="listenerscontextloaded-applicationpreparedevent">listeners.contextLoaded-&gt;ApplicationPreparedEvent</h2><p>相关监听器参考上面的描述。</p><h2 id="refresh-contextrefreshedevent">refresh-&gt;ContextRefreshedEvent</h2><ul><li><p>ConditionEvaluationReportLoggingListener：实际上实现的是 ApplicationContextInitializer接口，其目的是将 ConditionEvaluationReport 写入到日志，使用DEBUG级别输出。程序崩溃报告会触发一个消息输出，建议用户使用调试模式显示报告。它是在应用初始化时绑定一个ConditionEvaluationReportListener事件监听器，然后相应的事件发生时输出ConditionEvaluationReport报告。</p></li><li><p>ClearCachesApplicationListener：应用上下文加载完成后对缓存做清除工作，响应事件ContextRefreshedEvent。</p></li><li><p>SharedMetadataReaderFactoryContextInitializer： 向context注册了一个BeanFactoryPostProcessor：CachingMetadataReaderFactoryPostProcessor实例。</p></li><li><p>ResourceUrlProvider：handling mappings处理</p></li></ul><h2 id="started-applicationstartedevent">started-&gt;ApplicationStartedEvent</h2><p>相关监听器参考上面的描述。</p><h2 id="backgroundpreinitializerdelegatingapplicationlistener">BackgroundPreinitializer&amp;DelegatingApplicationListener</h2><p>这两个贯穿了整个过程，这里拎出来单独解释下：</p><ul><li><p>BackgroundPreinitializer：对于一些耗时的任务使用一个后台线程尽早触发它们开始执行初始化，这是SpringBoot的缺省行为。这些初始化动作也可以叫做预初始化。可以通过设置系统属性spring.backgroundpreinitializer.ignore为true可以禁用该机制。该机制被禁用时，相应的初始化任务会发生在前台线程。</p></li><li><p>DelegatingApplicationListener：监听应用事件，并将这些应用事件广播给环境属性context.listener.classes指定的那些监听器。</p></li></ul><h1 id="小结">小结</h1><p>到此，SpringBoot 中的事件相关的东西就结束了。本文从SpringApplicationRunListener这个类说起，接着介绍 SpringBoot 启动过程的事件以及事件的生命周期。最后介绍了 SpringBoot中的内置的这些 监听器在启动过程中对应的各个阶段。</p><p><a href="https://blog.csdn.net/weixin_28837817/article/details/112443549">原文</a></p><div style="margin-top:2em;padding:0 1.5em;border:1px solid #d3d3d3;background-color:#deebf7"><h3>文档信息</h3><ul><li>本文作者：<a href="https://hsfeng.site" target="_blank">hsfeng</a></li><li>本文链接：<a href="https://hsfeng.site/2022/05/31/java-springboot-applicationlistener/" target="_blank">https://hsfeng.site/2022/05/31/java-springboot-applicationlistener/</a></li><li>版权声明：自由转载-非商用-非衍生-保持署名（<a href="http://creativecommons.org/licenses/by-nc-nd/3.0/deed.zh" target="_blank">创意共享3.0许可证</a>）</li></ul></div></article><div class="share"></div><div class="comment"><div id="gitalk-container"></div><!--<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css"> --><link rel="stylesheet" href="https://hsfeng.site/assets/vendor/gitalk/gitalk.css"> <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script> <script> var gitalk = new Gitalk({ id: '/2022/05/31/java-springboot-applicationlistener/', clientID: 'add2b2d3d3f6c9fcaf30', clientSecret: '0956dc83645e36dfb8fa9292d948f1c4d201dd2b', repo: 'blog-comments', owner: 'hsfengbyte', admin: ['hsfengbyte'], labels: ['gitment'], perPage: 50, }); gitalk.render('gitalk-container'); </script></div></div><div class="column one-fourth"><h3>Search</h3><div id="site_search"> <input style="width:96%" type="text" id="search_box" placeholder="Search"></div><ul id="search_results" style="font-size:14px;list-style-type:none;padding-top:10px;padding-left:10px;"></ul><script src="https://hsfeng.site/assets/js/simple-jekyll-search.min.js"></script> <script type="text/javascript"> SimpleJekyllSearch({ searchInput: document.getElementById('search_box'), resultsContainer: document.getElementById('search_results'), json: 'https://hsfeng.site/assets/search_data.json?v=1654782562', searchResultTemplate: '<li><a href="{url}" title="{title}">{title}</a></li>', noResultsText: 'No results found', limit: 10, fuzzy: false, exclude: ['Welcome'] }) </script> <!--<script type="text/javascript"> SimpleJekyllSearch({ searchInput: document.getElementById('search_box'), resultsContainer: document.getElementById('search_results'), json: 'https://hsfeng.site/assets/search_data.json?v=1654782562', searchResultTemplate: '<li><a href="{url}" title="{title}">{title}</a></li>', noResultsText: 'No results found', limit: 10, fuzzy: false, exclude: ['Welcome'] }) </script>--><h3 class="post-directory-title mobile-hidden">Table of Contents</h3><div id="post-directory-module" class="mobile-hidden"><section class="post-directory"> <!-- Links that trigger the jumping --> <!-- Added by javascript below --><dl></dl></section></div><script src="https://hsfeng.site/assets/js/jquery.toc.js"></script></div></div></section><!-- /section.content --><footer class="container"><div class="site-footer" role="contentinfo"><div class="copyright left mobile-block"> © 2021 <span title="hsfeng">hsfeng</span> <a href="javascript:window.scrollTo(0,0)" class="right mobile-visible">TOP</a></div><ul class="site-footer-links right mobile-hidden"><li> <a href="javascript:window.scrollTo(0,0)" >TOP</a></li></ul><a href="https://github.com/hsfengbyte/hsfengbyte.github.io" target="_blank" aria-label="view source code"> <span class="mega-octicon octicon-mark-github" title="GitHub"></span> </a><ul class="site-footer-links mobile-hidden"><li> <a href="https://hsfeng.site/" title="首页" target="">首页</a></li><li> <a href="https://hsfeng.site/categories/" title="分类" target="">分类</a></li><li> <a href="https://hsfeng.site/archives/" title="归档" target="">归档</a></li><li> <a href="https://hsfeng.site/wiki/" title="维基" target="">维基</a></li><li> <a href="https://hsfeng.site/links/" title="链接" target="">链接</a></li><li> <a href="https://hsfeng.site/about/" title="关于" target="">关于</a></li><li><a href="https://hsfeng.site/feed.xml"><span class="octicon octicon-rss" style="color:orange;"></span></a></li></ul><!-- 不蒜子访问统计 --></div></footer><div class="tools-wrapper"> <a class="gotop" href="#" title="回到顶部"><span class="octicon octicon-arrow-up"></span></a></div><!-- / footer --> <script src="https://hsfeng.site/assets/js/geopattern.js"></script> <script> jQuery(document).ready(function($) { $('.geopattern').each(function(){ $(this).geopattern($(this).data('pattern-id')); }); /* hljs.initHighlightingOnLoad(); */ }); </script></body></html>
  
  

  


